<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background: #f5f7fb;
        }
        .card {
            border-radius: 20px;
        }
        .profile-photo {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 50%;
        }
        .action-buttons button,
        .action-buttons a {
            min-width: 120px;
        }

        .subject-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .subject-row>div {
            padding: 0 5px;
        }

        .subject-header {
            font-weight: bold;
        }

        .text-tba {
            color: #999;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="container mt-5">

        <!-- Student Info Card -->
        <div class="card p-4 shadow-lg" style="max-width: 900px; margin:auto;">
            <div class="row g-3 align-items-center">
                <div class="col-md-4 text-center">
                    {% if student.photo %}
                    <img src="{{ student.photo.url }}" alt="Student Photo" class="profile-photo">
                    {% else %}
                    <img src="https://via.placeholder.com/180" alt="No Photo" class="profile-photo">
                    {% endif %}
                </div>
                <div class="col-md-8">
                    <p><strong>Student Name:</strong> {{ student.sname }}</p>
                    <p><strong>Age:</strong> {{ student.sage }}</p>
                    <p><strong>College:</strong> {{ student.college.college_name }}</p>
                    <p><strong>Department:</strong> {{ student.department.dept_name }}</p>
                    <p><strong>Completed Semesters:</strong> {{ completed_semesters }}</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mt-4 action-buttons">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" id="toggleSubjectsBtn">View Subjects</button>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editStudentModal">
                        <i class="bi bi-pencil-square"></i> Edit
                    </button>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteStudentModal">
                        <i class="bi bi-trash-fill"></i> Delete
                    </button>
                    <a href="{% url 'export_student_pdf' student.sid %}"
   class="btn btn-success">
   <i class="bi bi-download"></i> Download PDF
</a>

                </div>
                <a href="{% url 'home' %}" class="btn btn-secondary">Back to Students</a>
            </div>
        </div>

        <!-- Subjects Section -->
        <div id="subjectsContainer" class="mt-4" style="display: none;">
            {% for sem_info in semester_subjects %}
            <form method="POST" action="{% url 'save_semester_marks' student.sid sem_info.semester.sem_id %}">
                {% csrf_token %}
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light">
                        <strong>{{ sem_info.semester.sem_name }} (Year {{ sem_info.semester.year }})</strong>
                        {% if not sem_info.is_completed %}
                        <span class="badge bg-secondary float-end">Upcoming</span>
                        {% endif %}
                    </div>
                    <div class="card-body">

                        <!-- Column Headers -->
                        <div class="subject-row subject-header">
                            <div class="col-4">Subject</div>
                            <div class="col-1">Subject Credits</div>
                            <div class="col-2">Add Marks</div>
                            <div class="col-2">Marks</div>
                            <div class="col-2"> Credits Earned</div>
                            <div class="col-3">Remarks</div>
                        </div>

                        {% if sem_info.subjects %}
                        {% with total_marks=0 %}
                        {% for item in sem_info.subjects %}
                        <div class="subject-row">
                            <div class="col-4">{{ item.subject.subject_name }}</div>
                            <div class="col-1">{{ item.subject.credits }}</div>
                            <div class="col-2">
                                {% if sem_info.is_completed %}
                                <input type="number" name="mark_{{ item.subject.subject_id }}" min="0" max="75"
                                    class="form-control" value="{{ item.marks|default:'' }}">
                                {% else %}
                                <span class="text-tba">TBA</span>
                                {% endif %}
                            </div>
                            <div class="col-2">
                                {% if sem_info.is_completed and item.marks is not None %}
                                {{ item.marks }}
                                {% with total_marks=total_marks|add:item.marks %}{% endwith %}
                                {% endif %}
                            </div>
                            <div class="col-2">
                                {% if sem_info.is_completed %}
                                {% if item.marks is not None %}
                                <strong>{{ item.earned_credits }}</strong> / {{ item.subject.credits }}
                                {% else %}
                                <span class="text-tba">– / {{ item.subject.credits }}</span>
                                {% endif %}
                                {% else %}
                                <span class="text-tba">– / {{ item.subject.credits }}</span>
                                {% endif %}
                            </div>

                            <div class="col-3">
                                {% if sem_info.is_completed and item.marks is not None %}
                                {% if item.marks >= 24 %}
                                <span class="text-success">Pass</span>
                                {% else %}
                                <span class="text-danger">Fail</span>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Totals Row -->
                        <div class="subject-row mt-2">
                            <div class="col-5"><strong>Total Subjects:</strong> {{ sem_info.subjects|length }}</div>
                            <div class="col-3"></div>
                            <div class="col-2"><strong>Total Marks:</strong> <span class="total-marks">0</span></div>
                            {% if sem_info.is_completed and sem_info.semester_gpa %}
                        <div class="col-5">
                            <strong>GPA:</strong><span>{{ sem_info.semester_gpa }}</span>
                        </div>
                        {% endif %}
                            <div class="col-2"></div>
                        </div>

                        {% endwith %}
                        {% else %}
                        <p class="text-muted">No subjects assigned for this semester.</p>
                        {% endif %}

                        <!-- Save Marks button -->
                        {% if sem_info.is_completed %}
                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-success">Save Marks</button>
                        </div>
                        {% endif %}

                    
                    </div>
                </div>
            </form>
            {% endfor %}

            <!-- Credits & CGPA Summary -->
            <div class="card p-3 mb-4">
    <h5>Summary</h5>

    <p>
        <strong>Total Credits Earned:</strong> {{ total_credits }}
    </p>

    <!-- ✅ RESULT LABEL + VALUE ONLY IF ALL SEMESTERS ARE COMPLETED -->
    {% if completed_semesters == semester_subjects|length %}
        <p>
            <strong>Result:</strong>
            {% if total_credits >= 35 %}
                <span class="badge bg-success">PASS</span>
            {% else %}
                <span class="badge bg-danger">FAIL</span>
            {% endif %}
        </p>
    {% endif %}

    <p>
        <strong>CGPA:</strong>
        {% if cgpa %}
            {{ cgpa }}
        {% else %}
            N/A
        {% endif %}
    </p>
</div>


    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header bg-warning text-white rounded-top-4">
                    <h5 class="modal-title">Edit Student</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{% url 'edit_student' student.sid %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Student Name</label>
                                <input type="text" name="student_name" class="form-control" value="{{ student.sname }}"
                                    required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Age</label>
                                <input type="number" name="student_age" class="form-control" value="{{ student.sage }}"
                                    required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Joined Year</label>
                                <input type="number" name="joined_year" class="form-control" min="2000"
                                    max="{{ current_year }}" value="{{ student.joined_year }}" required>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Photo</label>
                                <input type="file" name="student_image" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">College</label>
                                <select name="college" class="form-select" required>
                                    {% for college in colleges %}
                                    <option value="{{ college.cid }}"
    {% if college.cid == student.college.cid %}selected{% endif %}>
                                        {{ college.college_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Department</label>
                                <select name="department" class="form-select" required>
                                    {% for dept in departments %}
                                   <option value="{{ dept.did }}"
    {% if dept.did == student.department.did %}selected{% endif %}>

                                        {{ dept.dept_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Student Modal -->
    <div class="modal fade" id="deleteStudentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header bg-danger text-white rounded-top-4">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete student "<strong>{{ student.sname }}</strong>"?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <a href="{% url 'delete_student' student.sid %}" class="btn btn-danger">Delete</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Subjects Script -->
    <script>
        const toggleBtn = document.getElementById('toggleSubjectsBtn');
        const subjectsContainer = document.getElementById('subjectsContainer');
        toggleBtn.addEventListener('click', () => {
            if (subjectsContainer.style.display === 'none') {
                subjectsContainer.style.display = 'block';
                toggleBtn.textContent = 'Hide Subjects';
            } else {
                subjectsContainer.style.display = 'none';
                toggleBtn.textContent = 'View Subjects';
            }
        });
    </script>

    <script>
        document.querySelectorAll('.card-body').forEach(card => {
            const inputs = card.querySelectorAll('input[type="number"]');
            const totalSpan = card.querySelector('.total-marks');

            function calculateTotal() {
                let total = 0;
                inputs.forEach(input => {
                    let val = parseInt(input.value);
                    if (!isNaN(val)) total += val;
                });
                if (totalSpan) totalSpan.textContent = total;
            }

            inputs.forEach(input => {
                input.addEventListener('input', calculateTotal);
            });

            // Initialize total on page load
            calculateTotal();
        });
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('hidden.bs.modal', function () {
                const form = modal.querySelector('form');
                if (form) form.reset();
            });
        });
    </script>
</body>
</html>